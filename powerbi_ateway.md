## 1.Power BI 网关防火墙所需开放的出站地址和端口

| 域名                                                                                                | 端口          | 描述                                                                                                                                                                                             |
| :-------------------------------------------------------------------------------------------------- | :------------ | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `*.download.microsoft.com`                                                                          | `443` (TCP)   | 用于下载安装程序。网关应用程序也使用此域名检查版本和网关区域。                                                                                                                                     |
| `*.powerbi.com`                                                                                     | `443` (TCP)   | 用于识别相关的 Power BI 群集。                                                                                                                                                                  |
| `*.analysis.windows.net`                                                                            | `443` (TCP)   | 用于识别相关的 Power BI 群集。                                                                                                                                                                  |
| `*.login.windows.net`, `login.live.com`, `aadcdn.msauth.net`, `login.microsoftonline.com`, `*.microsoftonline-p.com` | `443` (TCP)   | 用于 Microsoft Entra ID 和 OAuth2 的网关应用程序身份验证。请注意，作为 Microsoft Entra ID 登录过程的一部分，可能需要租户特定的其他 URL。                                                               |
| `*.servicebus.windows.net`                                                                          | `5671-5672` (TCP) | 用于高级消息队列协议 (AMQP)。                                                                                                                                                                  |
| `*.servicebus.windows.net`                                                                          | `443` (TCP), `9350-9354` (TCP) | 侦听基于 TCP 的 Azure Relay。需要端口 `443` 来获取 Azure 访问控制令牌。                                                                                                                            |
| `*.msftncsi.com`                                                                                    | `80` (TCP)    | 如果 Power BI 服务无法访问网关，则用于测试 Internet 连接。                                                                                                                                         |
| `*.dc.services.visualstudio.com`                                                                    | `443` (TCP)   | AppInsights 用于收集遥测数据。                                                                                                                                                                  |

## 重要注意事项

* **Azure 区域：** 网关会与其关联的 Azure 区域建立出站连接。通常，这与您的 Power BI 租户或 Office 365 租户所在的区域相同。如果防火墙阻止出站连接，请配置防火墙以允许从网关到其关联 Azure 区域的出站连接。
* **IP 地址：** 建议使用完全限定的域名 (FQDN) 而不是 IP 地址，因为 IP 地址可能会更改。如果您的防火墙不支持通配符，您可以从 [Azure IP 范围和服务标记](https://learn.microsoft.com/zh-cn/azure/cloud-services/cloud-services-common-ports#find-the-ip-addresses) 获取 IP 地址列表。请注意，您需要每月同步更新这些 IP 地址列表。
* **HTTPS 模式：** 从 2019 年 6 月的网关版本开始，新安装默认使用 HTTPS 而不是 TCP。如果您强制网关通过 HTTPS 通信，它将仅使用 FQDN，而不会使用 IP 地址进行通信。您可以在网关应用程序中强制启用此行为。
* **网络端口测试：** 您可以定期在网关应用程序中运行网络端口测试，以获取所需端口的列表。在运行网关的计算机上，搜索并打开“On-premises data gateway”应用程序，选择“诊断”，然后在“网络端口测试”下选择“开始新测试”。测试完成后，您可以查看上次完成的测试结果。

请务必将这些地址和端口添加到您的防火墙出站规则中，以确保 Power BI 网关能够顺利连接到 Power BI 服务和您的数据源。如果您使用了代理服务器，也需要在网关配置中配置代理设置。


## 2.Power BI 网关防火墙方向及相关关系

**Power BI 网关防火墙方向：**

Power BI 网关主要需要配置**出站（Outbound）规则**。

* **出站规则：** 网关需要能够主动连接到 Power BI 服务和各种数据源（包括云端和本地）。因此，您需要在运行网关的服务器或网络防火墙上配置允许到特定域名和端口的出站连接。

**通常情况下，Power BI 网关本身**不需要任何入站（Inbound）端口**被外部网络打开。Power BI 服务不会主动直接连接到您的网关服务器发起通信。所有通信都由网关发起并建立。

**例外情况：** 在某些特定的高级或自定义配置中，例如涉及特定的网络拓扑或安全要求时，可能需要考虑特定的入站规则。然而，对于标准的 Power BI 网关部署，重点在于确保出站连接的畅通。

---

**Power BI、网关和 Azure 的关系：**

* **Power BI (SaaS 服务)：** Power BI 是一种基于云的业务分析服务，属于 Microsoft Power Platform 的一部分。用户通过 Power BI 服务（通常通过 Web 浏览器或 Power BI Desktop）创建报表、仪表板和进行数据分析。

* **Power BI 网关 (本地组件)：** Power BI 网关是一个在本地网络中运行的软件应用程序。它的主要作用是作为 Power BI 服务和无法直接通过互联网访问的本地数据源之间的桥梁。

    * **数据连接：** 当 Power BI 服务需要访问本地数据（例如 SQL Server 数据库、SharePoint 本地列表、文件共享等）时，它会将查询安全地发送到配置好的 Power BI 网关。
    * **数据传输：** 网关接收到查询后，会连接到本地数据源，检索数据，并将数据安全地传输回 Power BI 服务。
    * **计划刷新：** 网关还负责按照在 Power BI 服务中配置的计划自动刷新本地数据。

* **Azure (云基础设施)：** Azure 是 Microsoft 的云计算平台，为 Power BI 服务和许多数据源提供了基础设施。

    * **Power BI 服务托管在 Azure 上。**
    * 许多云端数据源（例如 Azure SQL 数据库、Azure Analysis Services、Azure Blob Storage 等）也位于 Azure 上。Power BI 服务可以直接通过互联网连接到这些云端数据源，通常不需要通过本地数据网关（除非存在特定的网络隔离或安全策略）。
    * Power BI 网关在与 Power BI 服务通信时，会涉及到与 Azure 服务总线（Azure Service Bus）等 Azure 服务的连接，以实现安全可靠的通信。

**简而言之：**

* Power BI 是云端分析服务。
* Power BI 网关是连接 Power BI 服务和本地数据源的桥梁。
* Azure 是支撑 Power BI 服务和许多数据源的底层云基础设施。网关与 Power BI 服务之间的安全通信也依赖于特定的 Azure 服务。


## 3.Power BI 网关的作用

Power BI 网关的主要作用是充当 Power BI 云服务和您的本地数据源之间的**安全桥梁**。由于安全性和网络隔离的原因，Power BI 云服务通常无法直接访问位于您本地网络（例如公司内部网络）中的数据。Power BI 网关解决了这个问题，使得 Power BI 能够连接和使用这些本地数据。

以下是 Power BI 网关更详细的作用：

* **连接本地数据源：**
    * Power BI 可以连接到各种各样的数据源，包括数据库（如 SQL Server、Oracle、MySQL）、文件共享、本地的 SharePoint 列表、以及其他通过 ODBC 或 OLE DB 连接的数据源。
    * 网关安装在可以访问这些本地数据源的服务器上。
    * 当您在 Power BI 服务中创建使用本地数据的报表或数据集时，网关充当连接器，使得 Power BI 服务能够与这些数据源通信。

* **安全的数据传输：**
    * 网关建立一个**出站**的连接到 Azure 服务总线（Azure Service Bus），这是一个安全的消息传递平台。Power BI 服务通过这个安全通道与您的本地网关进行通信。
    * 所有数据传输都经过加密，确保数据的安全性。
    * 您的本地数据和凭据不会直接暴露给 Power BI 云服务。

* **数据刷新：**
    * 对于需要定期更新的本地数据，您可以在 Power BI 服务中配置计划刷新。
    * 当刷新计划触发时，Power BI 服务会通过网关向本地数据源发送查询。
    * 网关执行查询，检索最新的数据，并将数据安全地传输回 Power BI 服务，从而保持您的报表和仪表板是最新的。

* **用户凭据管理：**
    * 当您配置数据源连接时，您需要在 Power BI 服务中提供访问本地数据源的凭据。
    * 这些凭据会安全地存储在 Power BI 服务中，并由网关在连接到数据源时使用。

* **集中管理：**
    * 通过 Power BI 管理门户，管理员可以集中管理组织中安装的所有网关及其数据源连接和用户权限。
    * 这提供了对数据连接和安全性的统一控制。

**简而言之，Power BI 网关使得 Power BI 能够安全可靠地访问和使用位于本地网络中的数据，从而扩展了 Power BI 的数据连接能力，让用户能够基于企业内部数据进行分析和决策。**

## 4.详细解释数据流向： 数据链路：Power BI 云服务 - Azure 总线 - 网关 - 本地数据
1.  **Power BI 云服务：**
    * 用户通过 Power BI 服务（例如，在 Web 浏览器中查看报表或配置数据刷新）发起对本地数据的请求。

2.  **Azure 服务总线 (Azure Service Bus)：**
    * Power BI 服务不会直接连接到您的本地网关。相反，它将请求安全地发送到 Azure 服务总线。
    * Azure 服务总线充当一个中间人或消息代理，负责安全可靠地传递消息。

3.  **Power BI 网关：**
    * 您安装在本地网络中的 Power BI 网关会**主动**连接到配置好的 Azure 服务总线。
    * 网关持续监听来自 Power BI 服务的请求。
    * 当 Azure 服务总线收到来自 Power BI 服务的针对特定网关的请求时，该请求会被安全地传递给相应的本地网关。

4.  **本地数据源：**
    * 接收到请求后，Power BI 网关会使用配置好的连接信息和凭据连接到您的本地数据源（例如数据库服务器、文件共享等）。
    * 网关执行 Power BI 服务发送过来的查询或刷新指令。
    * 从本地数据源检索到的数据随后会通过**相同的安全通道**，反向地通过网关和 Azure 服务总线，最终返回给 Power BI 云服务。

**总结：**

Power BI 云服务和本地网关之间的通信是通过 Azure 服务总线安全地中转的。网关始终发起与 Azure 服务总线的**出站连接**并保持监听状态。这种架构确保了本地数据环境的安全性，因为 Power BI 云服务不需要直接访问您的本地网络。


